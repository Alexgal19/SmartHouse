SmartHouse System: Prime Directive & Architectural Standards v2.0 (High-Integrity Mode)
Severity Level: CRITICAL Target Audience: AI Agents & Human Developers Goal: Zero-Error Execution, Security-First Architecture, Flawless UX.

0. THE COGNITIVE PROTOCOL (MANDATORY BEFORE CODING)
Before generating a single line of code, you MUST execute the following cognitive steps:

Intent Decoupling: Restate the user's goal in your own technical terms. If ambiguous, STOP and ask.

Impact Analysis: List all files that will be touched. Ask yourself: "Will changing X break Y?"

Test Strategy: Define how you will verify the change (Unit vs Integration).

Pseudo-Code Draft: For logic > 10 lines, write pseudo-code to verify algorithms.

1. General Rules & Philosophy
Stability over Features: Never break existing functionality to add a new one.

Scope Containment: Touch only what is necessary. If you see "messy code" nearby, DO NOT refactor it unless explicitly asked.

Filesystem Authority: You are responsible for the integrity of the entire file you modify. Never output incomplete snippets with // ... existing code.

Atomic Commits: Your changes should be logically grouped. Don't mix styling fixes with backend logic changes.

2. Zero-Error Protocol (Strict Type Safety)
No any Policy: The type any is strictly forbidden. Use unknown with type guards if necessary.

Zod Validation: All data entering the system (from API, Forms, or URL params) MUST be validated with Zod schemas.

Strict Null Checks: Always handle null and undefined. Never use the non-null assertion operator (!) unless you have strictly validated existence in the line before.

Linter Compliance: The code MUST pass eslint . and tsc --noEmit effectively.

3. Architecture & Separation of Concerns
3.1 Server-Side (Secure Context)
Location: src/lib/actions.ts, src/lib/sheets.ts, API Routes.

Rules:

Access process.env here ONLY.

Use "use server" for Server Actions.

Google Sheets: All interaction via google-auth-library happens here.

Security: Never pass raw Error objects to the client. Sanitize errors.

3.2 Client-Side (Interactive Context)
Location: src/components/*, src/hooks/*.

Rules:

Use "use client" at the top.

No Secrets: Never import server-only libraries (like googleapis) here.

Data Import: Use xlsx or SheetJS (Browser Build) for parsing Excel files locally.

State: Prefer URL state (searchParams) for shareable UI states over local useState where possible.

4. Testing & Verification (The "Green Light" Rule)
You cannot "see" the app. Tests are your eyes.

Business Logic: Every function in src/lib/* MUST have a unit test (.test.ts).

Mocking: NEVER hit real Google APIs in tests. Mock sheets.ts responses.

UI Flows: For critical forms, suggest an integration test plan (React Testing Library).

Self-Correction: If you write code, you must also provide the test case that proves it works.

5. Security & Data Integrity
Input Sanitization: Sanitize all inputs to prevent XSS and Injection.

Least Privilege: Component props should only receive the data they need, not the whole object.

Excel/CSV Import Protocol:

Phase 1 (Client): Parse file -> Validate Schema (Zod) -> Preview Data to User.

Phase 2 (User Action): User approves -> Data sent to Server Action.

Phase 3 (Server): Re-validate -> Save to DB/Sheets.

6. AI Output Contract (XML Format)
To ensure machine-readability of your changes, use this XML format strictly.

XML

<plan>
  <thought_process>
    [Step-by-step reasoning: 1. Analyze, 2. Strategy, 3. Risk Assessment]
  </thought_process>
  <verification>
    [How will this be tested? e.g., "Run npm test src/lib/parser.test.ts"]
  </verification>
</plan>

<changes>
  <change>
    <file>[ABSOLUTE PATH]</file>
    <content><![CDATA[
[FULL FILE CONTENT - NO SNIPPETS]
]]></content>
  </change>
</changes>
7. The "Optimizer" Agent Protocol (Human-in-the-Loop)
Context: Before executing any complex task, you must act as the "Optimizer" to refine the prompt.

SYSTEM PROMPT FOR OPTIMIZER:

"You are a Senior Software Architect. Your job is to INTERROGATE the user's request.

Analyze: Is the request ambiguous? (e.g., "Fix the button" -> Which button?)

Refine: Rewrite the prompt into technical steps (Components, Data Flow, Security).

Constraint Check: Apply all rules from this document (ESLint, Zod, Tests).

Output: Return a structured Markdown specification of the task for the user to approve."

Example Interaction: User: "I want to upload contacts." Optimizer: "I have prepared a specification for 'Contact Import Feature'. It includes: 1. File Upload UI (Client), 2. SheetJS Parsing (Client), 3. Zod Validation (Client+Server), 4. Server Action to save. Do you approve?"